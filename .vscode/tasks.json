{
  // Tasks to configure, build, and run unit tests via CTest
  "version": "2.0.0",
  "tasks": [
    {
      "label": "CMake: Clean",
      "type": "shell",
      "command": "powershell",
      "args": [
        "-NoProfile",
        "-ExecutionPolicy",
        "Bypass",
        "-Command",
        "Remove-Item -Path \"${workspaceFolder}/build\" -Recurse -Force -ErrorAction SilentlyContinue; if (!(Test-Path \"${workspaceFolder}/build\")) { New-Item -ItemType Directory -Path \"${workspaceFolder}/build\" | Out-Null }"
      ],
      "options": {
        "env": {
          "PATH": "C:/msys64/mingw64/bin;${env:PATH}"
        }
      },
      "group": "build",
      "problemMatcher": []
    },
    {
      "label": "CMake: Configure",
      "type": "shell",
      "command": "cmake",
      "args": ["-S", ".", "-B", "build"],
      "options": {
        "env": {
          // Ensure cmake is available if not on PATH
          "PATH": "C:/msys64/mingw64/bin;${env:PATH}"
        }
      },
      "group": "build",
      "dependsOn": ["CMake: Clean"],
      "problemMatcher": []
    },
    {
      "label": "CMake: Build",
      "type": "shell",
      "command": "cmake",
      "args": ["--build", "build", "--config", "Release"],
      "options": {
        "env": {
          "PATH": "C:/msys64/mingw64/bin;${env:PATH}"
        }
      },
      "group": "build",
      "dependsOn": ["CMake: Configure"],
      "problemMatcher": []
    },
    {
      "label": "CTest: Run All",
      "type": "shell",
      "command": "ctest",
      "args": ["--test-dir", "build", "-C", "Release", "--output-on-failure"],
      "options": {
        "env": {
          "PATH": "C:/msys64/mingw64/bin;${env:PATH}"
        }
      },
      "group": {
        "kind": "test",
        "isDefault": true
      },
      "dependsOn": ["CMake: Build"],
      "problemMatcher": []
    },
    {
      "label": "CTest: Run Single (SmokeTest.BasicTruth)",
      "type": "shell",
      "command": "ctest",
      "args": [
        "--test-dir", "build",
        "-C", "Release",
        "-R", "^SmokeTest\\.BasicTruth$",
        "--output-on-failure"
      ],
      "options": {
        "env": {
          "PATH": "C:/msys64/mingw64/bin;${env:PATH}"
        }
      },
      "group": "test",
      "dependsOn": ["CMake: Build"],
      "problemMatcher": []
    },
    {
      "label": "Build Tests",
      "type": "shell",
      "command": "g++",
      "args": [
        "-DDESK_CONTROLLER_ENABLE_TEST_INTERFACE",
        "-std=c++17",
        "-I${workspaceFolder}/source/arduino",
        "-I${workspaceFolder}/tests",
        "${workspaceFolder}/tests/UnitTests.cpp",
        "${workspaceFolder}/source/arduino/DeskController.cpp",
        "-lgtest",
        "-lgtest_main",
        "-pthread",
        "-o",
        "${workspaceFolder}/tests/desk_tests"
      ],
      "group": {
        "kind": "build",
        "isDefault": true
      },
      "problemMatcher": ["$gcc"]
    }
  ]
}
